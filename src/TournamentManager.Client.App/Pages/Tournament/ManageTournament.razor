@page "/Tournament/Manage/{Id}"
@using TournamentManager.Common.Models
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Manage Tournament</PageTitle>

<div id="wrapper">
<div class="d-flex flex-column" id="content-wrapper">
<div id="content">
<div class="container-fluid">
<div class="row mb-3">
    <div class="col d-xl-flex d-flex align-items-center">
        <h3 class="text-dark d-xl-flex">@_tournament?.Name</h3>
    </div>
    <div class="col col-auto"><a href="/Tournament/List"><button class="btn btn-light" type="button">Back to All Tournaments</button></a></div>
    @if (_loggedUser is not null && _loggedUser.Id == _tournament?.CreatorId)
    {
        <div class="col col-auto d-flex align-items-center"><button class="btn btn-danger" @onclick="DeleteTournament" type="button">Delete Tournament</button></div>
    }
</div>
<div class="row">
    @if (!_resultOk)
    {
        <p class="text-danger"><i class="fas fa-exclamation-circle pe-0 me-1"></i>@_errorMessage</p>
    }
    <div class="col">
        <div class="card shadow mb-4">
            <div class="card-header">
                <h6 class="text-primary mb-0">Pending sign-ups</h6>
            </div>
            <div class="card-body">
                @if (_pendingParticipants is null)
                {
                    <p class="text-center fw-bold">Loading...</p>
                }
                else
                {
                    <div class="row">
                        <div class="col-md-6 text-nowrap">
                            <div id="dataTable_length" class="dataTables_length" aria-controls="dataTable">
                                <label class="form-label">Show&nbsp;
                                    <select @onchange="OnItemsOnPageChanged" class="d-inline-block form-select form-select-sm">
                                        <option value="1">1</option>
                                        <option value="10" selected="selected">10</option>
                                        <option value="25">25</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>&nbsp;
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="text-md-end dataTables_filter" id="dataTable_filter"><label class="form-label"><input type="search" @oninput="OnSearchQueryChanged" class="form-control form-control-sm" aria-controls="dataTable" placeholder="Search"></label></div>
                        </div>
                    </div>
                    <div class="table-responsive table mt-2" id="dataTable-1" role="grid" aria-describedby="dataTable_info">
                        @if (PendingParticipantsFiltered.Count == 0)
                        {
                            <p class="text-center fw-bold">No pending participants found</p>
                        }
                        else
                        {
                            <table class="table my-0" id="dataTable">
                                <thead>
                                <tr>
                                    <th>Team Name</th>
                                    <th>Team Leader</th>
                                    <th>Date Registered</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody>
                                @foreach (var participant in PendingParticipantsPages[_selectedPageIndex])
                                {
                                    var leader = _teamLeaders?.Where(x => x.Id == participant.Team?.LeaderId).ToList()[0];
                                    <tr>
                                        <td>@participant.Team?.Name</td>
                                        <td>@leader?.FirstName @leader?.LastName</td>
                                        <td>Datum registrace?</td>
                                        <td class="text-center"><i @onclick="() => ApproveParticipant(participant)" class="fas fa-user-check me-1" data-bs-toggle="tooltip" data-bss-tooltip="" data-bs-placement="right" title="Approve participant"></i><i @onclick="() => DeleteParticipant(participant)" class="fas fa-user-times" data-bs-toggle="tooltip" data-bss-tooltip="" data-bs-placement="right" title="Reject participant"></i></td>
                                    </tr>
                                }
                                </tbody>
                                <tfoot>
                                <tr></tr>
                                </tfoot>
                            </table>
                        }
                    </div>
                    <div class="row">
                        <div class="col-md-6 align-self-center">
                            <p id="dataTable_info" class="dataTables_info" role="status" aria-live="polite">Showing @(1 + _selectedPageIndex * _showCount) to @((_showCount + _selectedPageIndex * _showCount) < PendingParticipantsFiltered.Count ? (_showCount + _selectedPageIndex * _showCount) : PendingParticipantsFiltered.Count) of @(PendingParticipantsFiltered.Count)</p></div>
                        <div class="col-md-6">
                            <nav class="d-lg-flex justify-content-lg-end dataTables_paginate paging_simple_numbers">
                                <ul class="pagination">
                                    <li class="page-item @(_selectedPageIndex <= 0 ? "disabled" : "")"><a role="button" class="page-link" aria-label="Previous" @onclick="() => _selectedPageIndex--" ><span class="user-select-none" aria-hidden="true">«</span></a></li>
                                    @for (var i = _selectedPageIndex - 1; i <= _selectedPageIndex + 1; i++)
                                    {
                                        var num = i;
                                        if (_selectedPageIndex == 0)
                                            num = i + 1; // So user cant go to page -1

                                        else if (_selectedPageIndex >= PendingParticipantsFiltered.Count - 1)
                                            num = i - 1; // So user cant go to a page that is too high
                                        
                                        if (num > PendingParticipantsFiltered.Count - 1)
                                        {
                                            break; // If there are fewer than 3 pages total
                                        }
                                        else if (_selectedPageIndex == 1 && PendingParticipantsFiltered.Count == 2 && i == 0)
                                        {
                                            // If only 2 pages are available, clicking the second one would make page 0 appear
                                            // which is obviously not possible
                                            continue;
                                        }

                                        <li class="page-item @(_selectedPageIndex == num ? "active" : "")">
                                            <a class="page-link" @onclick="() => _selectedPageIndex = num" role="button">@(num + 1)</a>
                                        </li>
                                    }
                                    <li class="page-item @(_selectedPageIndex >= @PendingParticipantsFiltered.Count - 1 ? "disabled" : "")">
                                        <a class="page-link" aria-label="Next" @onclick="() => _selectedPageIndex++" role="button"><span class="user-select-none" aria-hidden="true">»</span></a>
                                    </li>
                                    </ul>
                            </nav>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card shadow">
            <div class="card-header">
                <h6 class="text-primary mb-0">Participants</h6>
            </div>
            <div class="card-body">
                @if (_approvedParticipants is null)
                {
                    <p class="text-center fw-bold">Loading...</p>
                }
                else
                {
                    <div class="row">
                        <div class="col-md-6 text-nowrap">
                            <div id="dataTable_length-3" class="dataTables_length" aria-controls="dataTable">
                                <label class="form-label">Show&nbsp;
                                    <select class="d-inline-block form-select form-select-sm">
                                        <option value="10" selected="selected">10</option>
                                        <option value="25">25</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>&nbsp;</label></div>
                        </div>
                        <div class="col-md-6">
                            <div class="text-md-end dataTables_filter" id="dataTable_filter-3"><label class="form-label"><input type="search" class="form-control form-control-sm" aria-controls="dataTable" placeholder="Search"></label></div>
                        </div>
                    </div>
                    <div class="table-responsive table mt-2" id="dataTable-4" role="grid" aria-describedby="dataTable_info">
                        @if (_approvedParticipants.Count == 0)
                        {
                            <p class="text-center fw-bold">No participants found</p>
                        }
                        else
                        {
                            <table class="table my-0" id="dataTable">
                                <thead>
                                <tr>
                                    <th>Team Name</th>
                                    <th>Team Leader</th>
                                    <th>Date Registered</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody>
                                @foreach (var participant in _approvedParticipants)
                                {
                                    var leader = _teamLeaders?.Where(x => x.Id == participant.Team?.LeaderId).ToList()[0];
                                    <tr>
                                        <td>@participant.Team?.Name</td>
                                        <td>@leader?.FirstName @leader?.LastName</td>
                                        <td>Datum registrace?</td>
                                        <td class="text-center"><i @onclick="() => DeleteParticipant(participant)" class="fas fa-user-times" data-bs-toggle="tooltip" data-bss-tooltip="" data-bs-placement="right" title="Remove participant"></i></td>
                                    </tr>
                                }
                                </tbody>
                                <tfoot>
                                <tr></tr>
                                </tfoot>
                            </table>
                        }
                    </div>
                    <div class="row">
                        <div class="col-md-6 align-self-center">
                            <p id="dataTable_info-3" class="dataTables_info" role="status" aria-live="polite">Showing 1 to 10 of 27</p>
                        </div>
                        <div class="col-md-6">
                            <nav class="d-lg-flex justify-content-lg-end dataTables_paginate paging_simple_numbers">
                                <ul class="pagination">
                                    <li class="page-item disabled"><a class="page-link" aria-label="Previous" href="#"><span aria-hidden="true">«</span></a></li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                                    <li class="page-item"><a class="page-link" aria-label="Next" href="#"><span aria-hidden="true">»</span></a></li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col">
        <h4 class="text-center text-primary"><span style="color: rgba(var(--bs-primary-rgb), var(--bs-text-opacity)) ;">Tournament Matches</span><br></h4>
    </div>
</div>
<div class="row">
    <div class="col">
        <div class="card mb-4 shadow">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <h6 class="text-primary">Round 1</h6>
                    </div>
                    <div class="col">
                        <p>25. 5. 2020<br></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <p><img class="img-fluid" width="60" height="60" src="../assets/img/avatars/avatar3.jpeg">Team1</p>
                    </div>
                    <div class="col align-self-center">
                        <p class="lead text-center">0</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <p><img class="img-fluid" width="60" height="60" src="../assets/img/avatars/avatar3.jpeg">Team2</p>
                    </div>
                    <div class="col align-self-center">
                        <p class="lead text-center">3</p>
                    </div>
                </div>
                <div class="row justify-content-end">
                    <div class="col col-auto"><button class="btn btn-primary" type="button">Manage</button></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card mb-4 shadow">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <h6 class="text-primary">Round 1</h6>
                    </div>
                    <div class="col">
                        <p>25. 5. 2020</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <p><img class="img-fluid" width="60" height="60" src="../assets/img/avatars/avatar3.jpeg">Team1</p>
                    </div>
                    <div class="col align-self-center">
                        <p class="lead text-center">0</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <p><img class="img-fluid" width="60" height="60" src="../assets/img/avatars/avatar3.jpeg">Team2</p>
                    </div>
                    <div class="col align-self-center">
                        <p class="lead text-center">3</p>
                    </div>
                </div>
                <div class="row justify-content-end">
                    <div class="col col-auto"><button class="btn btn-primary" type="button">Manage</button></div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col">
        <div class="card mb-4 shadow">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <h6 class="text-primary">Round 1</h6>
                    </div>
                    <div class="col">
                        <p>25. 5. 2020<br></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <p><img class="img-fluid" width="60" height="60" src="../assets/img/avatars/avatar3.jpeg">Team1</p>
                    </div>
                    <div class="col align-self-center">
                        <p class="lead text-center">0</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <p><img class="img-fluid" width="60" height="60" src="../assets/img/avatars/avatar3.jpeg">Team2</p>
                    </div>
                    <div class="col align-self-center">
                        <p class="lead text-center">3</p>
                    </div>
                </div>
                <div class="row justify-content-end">
                    <div class="col col-auto"><button class="btn btn-primary" type="button">Manage</button></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card mb-4 shadow">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <h6 class="text-primary">Round 1</h6>
                    </div>
                    <div class="col">
                        <p>25. 5. 2020<br></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <p><img class="img-fluid" width="60" height="60" src="../assets/img/avatars/avatar3.jpeg">Team1</p>
                    </div>
                    <div class="col align-self-center">
                        <p class="lead text-center">0</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <p><img class="img-fluid" width="60" height="60" src="../assets/img/avatars/avatar3.jpeg">Team2</p>
                    </div>
                    <div class="col align-self-center">
                        <p class="lead text-center">3</p>
                    </div>
                </div>
                <div class="row justify-content-end">
                    <div class="col col-auto"><button class="btn btn-primary" type="button">Manage</button></div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
</div>
</div><a class="border rounded d-inline scroll-to-top" href="#page-top"><i class="fas fa-angle-up"></i></a>
</div>

@code {

    [Parameter]
    public string? Id { get; set; }

    private TournamentModel? _tournament;
    private UserModel? _loggedUser;
    private List<MatchModel>? _matches;
    private List<TeamIsParticipatingModel>? _approvedParticipants;
    private List<TeamIsParticipatingModel>? _pendingParticipants;
    private List<UserModel>? _teamLeaders;
    private int _showCount = 10;
    private int _selectedPageIndex;
    private string _searchPending = "";

    private bool _resultOk = true;
    private string _errorMessage = String.Empty;

    private List<TeamIsParticipatingModel> PendingParticipantsFiltered => _pendingParticipants?
        .Where(x =>
        {
            var name = x.Team != null && x.Team.Name.ToLower().Contains(_searchPending.ToLower());
            return name;
        }).ToList() ??
    new ();
    
    private List<List<TeamIsParticipatingModel>> PendingParticipantsPages => PendingParticipantsFiltered.Select((x, i) => new  // Splits the one big list into smaller lists of size _showCount
    {
        Index = i,
        Value = x
    }).GroupBy(x => x.Index / _showCount)
        .Select(x => x.Select(v => v.Value).ToList())
        .ToList();
    

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _tournament = await Http.GetFromJsonAsync<TournamentModel>($"/api/Tournament/{Id}");
            _matches = _tournament?.Matches.ToList() ?? new List<MatchModel>();
            var allParticipants = await Http.GetFromJsonAsync<List<TeamIsParticipatingModel>>("/api/TeamIsParticipating") ?? new();
            _approvedParticipants = allParticipants.Where(x => x.TournamentId == _tournament?.Id && x.Approved).ToList();
            _pendingParticipants = allParticipants.Where(x => x.TournamentId == _tournament?.Id && !x.Approved).ToList();
            _teamLeaders = new();
            
            foreach (var participant in allParticipants)
            {
                var teamLeaderId = (await Http.GetFromJsonAsync<TeamModel>($"/api/Team/{participant.TeamId}"))?.LeaderId;
                if (teamLeaderId is null) continue;
                
                var teamLeader = await Http.GetFromJsonAsync<UserModel>($"/api/User/{teamLeaderId}");
                if (teamLeader is not null)
                {
                    _teamLeaders.Add(teamLeader);
                }
            }



            _loggedUser = await Http.GetFromJsonAsync<UserModel>("/api/User/current");
        }
        catch (AccessTokenNotAvailableException exception)
        {
            exception.Redirect();
        }
    }

    private async Task DeleteTournament()
    {
        try
        {
            if (_tournament is not null)
            {
                var result = await Http.DeleteAsync($"/api/Tournament/{_tournament.Id}");
                if (result.IsSuccessStatusCode)
                {
                    Navigation.NavigateTo("/Tournament/List");
                    _errorMessage = "";
                }
                else
                {
                    _resultOk = false;
                    _errorMessage = "Unable to delete the tournament.";
                }
            }
        }
        catch (AccessTokenNotAvailableException exception)
        {
            exception.Redirect();
        }
    }

    private async Task ApproveParticipant(TeamIsParticipatingModel? participant)
    {
        if (participant is not null)
        {
            participant.Approved = true;
            var result = await Http.PutAsJsonAsync("/api/TeamIsParticipating", participant);
            if (!result.IsSuccessStatusCode)
            {
                participant.Approved = false;
                _resultOk = false;
                _errorMessage = "Unable to approve the participant.";
            }
            else
            {
                _resultOk = true;
                _errorMessage = "";
                _pendingParticipants?.Remove(participant);
                _approvedParticipants?.Add(participant);
            }
        }
    }

    private async Task DeleteParticipant(TeamIsParticipatingModel? participant)
    {
        if (participant is not null)
        {
            try
            {
                var result = await Http.DeleteAsync($"/api/TeamIsParticipating/{participant.Id}");
                if (result.IsSuccessStatusCode)
                {
                    _pendingParticipants?.Remove(participant);
                    _approvedParticipants?.Remove(participant);
                    _resultOk = true;
                    _errorMessage = "";
                }
                else
                {
                    _resultOk = false;
                    _errorMessage = "Unable to delete the participant.";
                }

            }
            catch (AccessTokenNotAvailableException exception)
            {
                exception.Redirect();
            }
        }
    }
    private void OnItemsOnPageChanged(ChangeEventArgs e)
    {
        _selectedPageIndex = 0;
        _showCount = int.Parse(e.Value?.ToString() ?? "10");
    }
    
    private void OnSearchQueryChanged(ChangeEventArgs e)
    {
        _searchPending = e.Value?.ToString() ?? "";
        _selectedPageIndex = 0;
    }
    
    

}
